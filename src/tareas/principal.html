<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agendas de actividades</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.1.3/socket.io.js"></script>
    <script src="../js/socket.js"></script>
    <link rel="stylesheet" href="../styles/styles.css">
</head>

<body>
    <h1>TAREAS</h1>
    <div id="notificacion" class="notificacion-container"></div>
    <div id="mensaje-container"></div>
    <div class="container">
        <canvas id="GraficaBarras" width="400" height="400"></canvas>
    </div>

    <ul id="listaTareas"></ul>

    <h3>COMENTARIOS</h3>
    <ul id="comentarios"></ul>


    <script>
        const tareasUl = document.getElementById("GraficaBarras");
        let ultimoIdTarea = 0;
        let responsableCount = {};
        let myBarChart;
        var token = localStorage.getItem("token");

        function pintarTareas(tareas) {
            tareas.forEach(tarea => {
                const li = document.createElement("li");
                li.innerText = `${tarea.id} - ${tarea.tarea} - ${tarea.descripcion} - ${tarea.responsable}`;
                tareasUl.appendChild(li);

                responsableCount[tarea.responsable] = (responsableCount[tarea.responsable] || 0) + 1;
            });

            actualizarGraficaBarras();
        }

        function actualizarGraficaBarras() {
            const responsables = Object.keys(responsableCount);
            const tareasPorResponsable = responsables.map(responsable => responsableCount[responsable]);

            if (myBarChart) {
                myBarChart.destroy();
            }

            const ctx = document.getElementById("GraficaBarras").getContext("2d");
            myBarChart = new Chart(ctx, {
                type: "bar",
                data: {
                    labels: responsables,
                    datasets: [{
                        label: 'NÃºmero de Tareas',
                        data: tareasPorResponsable,
                        backgroundColor: getRandomColorArray(responsables.length)
                    }]
                },
                options: {
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        function getRandomColorArray(count) {
            const colors = [];
            for (let i = 0; i < count; i++) {
                const randomColor = `#${Math.floor(Math.random()*16777215).toString(16)}`;
                colors.push(randomColor);
            }
            return colors;
        }

        function obtenerTareas() {
            fetch('http://localhost:3000/obtener-lista', {
                    headers: {
                        "Authorization": token,

                    }
                })
                .then(res => res.json())
                .then(data => {
                    const tareas = data.tarea;
                    pintarTareas(tareas);
                    ultimoIdTarea = tareas[tareas.length - 1].id;

                    obtenerTareasNuevas(3000);
                })
                .catch(console.error);
        }

        function obtenerTareasNuevas(interval) {
            fetch(`http://localhost:3000/actualizar?idTarea=${ultimoIdTarea}`, {
                    headers: {
                        "Authorization": token,

                    }
                })
                .then(resp => resp.json())
                .then(data => {
                    const nuevasTareas = data.tareas;

                    if (nuevasTareas.length > 0) {
                        pintarTareas(nuevasTareas);
                        ultimoIdTarea = nuevasTareas[nuevasTareas.length - 1].id;
                    }

                    setTimeout(() => obtenerTareasNuevas(interval), interval);
                })
                .catch(console.error);
        }

        obtenerTareas();



        const comentariosUl = document.getElementById("comentarios");

        function pintarcomentario(comentario) {
            const li = document.createElement("li");
            li.innerText = `${comentario.id} - ${comentario.comentario}`;

            comentariosUl.appendChild(li);
        }

        function pintarcomentarios(comentarios) {
            for (comentario of comentarios) {
                pintarcomentario(comentario);
            }
        }

        async function obtenerComentarios() {
            const res = await fetch('http://localhost:3000/comentarios', {
                headers: {
                    "Authorization": token,

                }
            });
            const data = await res.json();

            if (data.comentario.length > 0) {
                pintarcomentarios(data.comentario);
            }
        }

        async function obtenerNuevosComentarios() {
            try {
                const res = await fetch(`http://localhost:3000/nuevo-comentario`, {
                    headers: {
                        "Authorization": token,

                    }
                });
                const data = await res.json();

                pintarcomentario(data.comentario);
            } catch (error) {
                console.log(error)
            } finally {
                obtenerNuevosComentarios();
            }
        }

        (async() => {
            await obtenerComentarios();
            obtenerNuevosComentarios();
        })();




        function conectarServidorWS() {
            let socket = new WebSocket('ws://localhost:4000');

            socket.onopen = event => {
                console.log("Cliente conectado");
            }

            socket.onmessage = event => {
                const data = JSON.parse(event.data);

                if (data.type === 'notification') {
                    notificacion(data.message);
                }
            }

            socket.onclose = event => {
                console.log("Cliente desconectado");

                setTimeout(() => {
                    console.log('Intentando reconectar...');
                    conectarServidorWS();
                }, 3000);
            }
        }

        function notificacion(message) {
            const mensajeContainer = document.getElementById('mensaje-container');
            mensajeContainer.innerText = message;
            mensajeContainer.style.display = 'block';

            setTimeout(() => {
                mensajeContainer.style.display = 'none';
            }, 2000);
        }

        conectarServidorWS();

        const socket = io('http://localhost:3000');

        socket.on('connect', () => {
            console.log('Conectado al servidor Socket.IO');
        });

        socket.on('disconnect', () => {
            console.log('Desconectado del servidor Socket.IO');
        });


        socket.on('notificacion', (message) => {
            showNotification(message, 2000);
        });

        function showNotification(message, duration) {
            const notificationDiv = document.getElementById('notificacion');
            notificationDiv.textContent = message;
            notificationDiv.style.display = 'block';

            setTimeout(() => {
                notificationDiv.style.display = 'none';
            }, duration);
        }
    </script>
</body>

</html>